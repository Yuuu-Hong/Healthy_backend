<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>é£Ÿç‰©è¾¨è­˜ä¸Šå‚³</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f8fafc;
            margin: 0;
        }

        .container {
            max-width: 420px;
            margin: 40px auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(60, 80, 120, 0.08);
            padding: 28px 24px;
        }

        h2 {
            color: #2d3a4b;
            border-left: 4px solid #5b9df9;
            padding-left: 10px;
        }

        input[type="file"] {
            margin-bottom: 16px;
        }

        button {
            background: linear-gradient(90deg, #5b9df9 60%, #6ed0f6 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 22px;
            font-size: 15px;
            cursor: pointer;
        }

        button:hover {
            background: linear-gradient(90deg, #357ae8 60%, #4ecbe6 100%);
        }

        .result {
            background: #f1f3f6;
            border-radius: 6px;
            padding: 10px 12px;
            margin-top: 12px;
            font-size: 14px;
            color: #2d3a4b;
            min-height: 18px;
        }

        #save-btn {
            display: none;
            margin-top: 18px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>ä¸Šå‚³é£Ÿç‰©ç…§ç‰‡</h2>
        <input type="file" id="food-photo" accept="image/*">
        <button onclick="uploadPhoto()">ä¸Šå‚³ä¸¦è¾¨è­˜</button>
        <div id="upload-result" class="result"></div>
        <button id="save-btn">ä¿å­˜</button>
    </div>
    <script>
        // ç¾åŒ–é£Ÿç‰©è¾¨è­˜çµæœ
        function formatFoodResult(data) {
            if (!data || !data.detected_foods || data.detected_foods.length === 0) {
                return "æœªè¾¨è­˜åˆ°ä»»ä½•é£Ÿç‰©";
            }
            let str = "";
            // 1. é£Ÿç‰©åå­—
            str += "ğŸ½ï¸ é£Ÿç‰©åç¨±ï¼š\n";
            data.detected_foods.forEach((food, idx) => {
                str += `  ${idx + 1}. ${food.class_name}\n`;
            });

            // 2. å€‹åˆ¥é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Š
            str += "\nğŸ“Š å€‹åˆ¥é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Šï¼š\n";
            data.nutrition_info.forEach((info, idx) => {
                if (info) {
                    str += `  ${info.name}ï¼š\n`;
                    str += `    å¡è·¯é‡Œï¼š${info.calories} kcal\n`;
                    str += `    è›‹ç™½è³ªï¼š${info.protein} g\n`;
                    str += `    è„‚è‚ªï¼š${info.fat} g\n`;
                    str += `    ç¢³æ°´åŒ–åˆç‰©ï¼š${info.carbohydrates} g\n`;
                    str += `    ç³–ï¼š${info.sugar} g\n`;
                    str += `    è†½å›ºé†‡ï¼š${info.cholesterol} mg\n`;
                } else {
                    str += `  æŸ¥ç„¡ç¬¬${idx + 1}é …é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Š\n`;
                }
            });

            // 3. ç¸½ç‡Ÿé¤Šè³‡è¨Š
            if (data.total_nutrition) {
                str += "\nğŸ§® ç¸½ç‡Ÿé¤Šè³‡è¨Šï¼š\n";
                str += `  ç¸½å¡è·¯é‡Œï¼š${data.total_nutrition.total_calories} kcal\n`;
                str += `  ç¸½è›‹ç™½è³ªï¼š${data.total_nutrition.total_protein} g\n`;
                str += `  ç¸½è„‚è‚ªï¼š${data.total_nutrition.total_fat} g\n`;
                str += `  ç¸½ç¢³æ°´åŒ–åˆç‰©ï¼š${data.total_nutrition.total_carbs} g\n`;
                str += `  ç¸½ç³–ï¼š${data.total_nutrition.total_sugar} g\n`;
                str += `  ç¸½è†½å›ºé†‡ï¼š${data.total_nutrition.total_cholesterol} mg\n`;
            }
            return str;
        }

        // ä¸Šå‚³é£Ÿç‰©ç…§ç‰‡
        function uploadPhoto() {
            const fileInput = document.getElementById('food-photo');
            if (!fileInput.files.length) {
                document.getElementById('upload-result').innerText = 'è«‹é¸æ“‡ç…§ç‰‡';
                return;
            }
            const formData = new FormData();
            formData.append('photo', fileInput.files[0]);
            formData.append('username', localStorage.getItem('username'));

            fetch('/food/upload', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('upload-result').innerText = formatFoodResult(data);
                    showSaveButton();
                })
                .catch(err => {
                    document.getElementById('upload-result').innerText = 'ä¸Šå‚³å¤±æ•—';
                });
        }

        // é¡¯ç¤ºä¿å­˜æŒ‰éˆ•
        function showSaveButton() {
            document.getElementById('save-btn').style.display = 'block';
        }

        // ç¶å®šä¿å­˜æŒ‰éˆ•äº‹ä»¶ï¼šé»æ“Šå¾Œè·³è½‰å› main.html
        document.getElementById('save-btn').onclick = function () {
            location.href = 'main.html';
        };
    </script>
</body>

</html>